# Transformer Tool Status Summary - 2026-02-14

## Purpose
This file is the current handoff snapshot for the MATLAB/Octave + Python stack in `PEEC_Script`.
It captures all completed work through the end of the 2026-02-14 session, including recommendation pipeline fixes, GUI improvements, and visualization hardening.

## Scope Covered
- Topology wizard recommendation path (`topology_wizard.m` + `generate_om_recommendations.py`)
- Interactive GUI behavior (`interactive_winding_designer.m`)
- OpenMagnetics visualization pipeline (`generate_om_visualization.py` + SVG parser/render path)
- Excitation + PEEC run flow and results page reporting

---

## Completed Work

### 1) Recommendation pipeline (wizard) stabilized — prior session
- Fixed repeated PyOpenMagnetics import failures in wizard flow by hardening Python fallback behavior.
- Fixed MAS advisor request formatting issues in recommendation script:
  - Ensure databases are loaded (`pm.load_databases({})`) before advisor calls.
  - Strip `null` fields from processed payloads before passing to advisor.
  - Topology name normalization for 2-switch-forward naming variants (map table in `build_mas_inputs()`).
  - Parse advisor outputs more robustly.
- Recommendation list behavior improved:
  - Sorting by score descending.
  - Added relative `% of best` display text.
- Wizard button label changed from `Continue without Recommendation` to `Analyze Design`.

### 2) Wizard-to-designer handoff expanded — prior session
- `design_spec` application now attempts to transfer and apply:
  - supplier, core shape, material
  - primary/secondary wire
  - turns/frequency/current/voltage data
- Added diagnostics in console to show what fields were successfully applied.
- Added robust sanitize/lookup behavior for recommendation keys.

### 3) OM visualization generation hardened — prior session
- Core shape resolution now supports direct name lookup, aliases, and sanitized key matching fallback.
- Material resolution improved.
- Core type inference added (toroidal vs closed-shape vs two-piece-set) before core-data generation.
- Toroidal guard: gapping removed for toroids before winding generation to avoid PM failures.
- Improved error handling around OM `wind`/`wind_by_turns` and metadata export.
- Added core key/aliases into visualization config generated by MATLAB.

### 4) OM SVG rendering fixes in GUI — prior session
- Fixed "random circles/no core" in OM view for toroidal outputs (stroke-only circles now parsed).
- OM window metrics text now reports `OM: n/a (no bobbin window)` when metadata has no bobbin window dimensions.

### 5) Results page usability changes — prior session
- Kept Worst/Best case dropdown and case re-plot workflow.
- Removed top-left overlay annotations that were overlapping current-density plot/title.
- Reworked results layout using explicit axis positions to avoid overlap and crowding.
- Winding loss comparison legend restored to `DC Loss` / `AC Loss`.
- Added selected operating-point details in `Core & Configuration` panel (duty, conduction mode, line/load scale, RMS V/I, worst/best names).

### 6) Main GUI simplification — prior session
- Removed GUI sections: `Excitation for PEEC Analysis` panel, `Data Mode / Server URL / Status` controls.
- Expanded the three main panels vertically to use recovered space.
- Repositioned bottom buttons (`Run Analysis`, `Reset to Defaults`, `Export MAS`) into clean non-overlapping layout.
- Title simplified to `Interactive Transformer Design Tool`.

### 7) Recommendation weights now functional — current session (2026-02-14)

**Problem**: Changing converter specifications (Vin, Vout, Iout, fsw) and weight sliders (Cost, Losses, Size) in the topology wizard always produced the same recommendations.

**Root causes identified and fixed**:

#### 7a) Weights never passed to PyOpenMagnetics advisor
- `pm.calculate_advised_magnetics()` only accepts 3 parameters (inputs, max_results, core_mode) — no weights parameter in the Python binding.
- **Fix**: Implemented client-side re-scoring via `apply_user_weights()` in `generate_om_recommendations.py`. Requests a larger candidate pool (3x requested count, min 15), then re-scores using COST/LOSSES/DIMENSIONS per-filter scores with user-specified weights, re-sorts descending, and trims to requested count.

#### 7b) Weight key mismatch (EFFICIENCY vs LOSSES)
- MATLAB config sent `config.weights.EFFICIENCY` but the PyOpenMagnetics scoring-per-filter uses the key `LOSSES`.
- **Fix**: Changed MATLAB to send `config.weights.LOSSES` and added mapping in Python: `api_weights["EFFICIENCY"] = weights.get("LOSSES", ...)`.

#### 7c) Independent weight sliders instead of linked 100%
- Each slider callback only updated its own value with no interaction between sliders. On the OpenMagnetics website, the three sliders always sum to 100%.
- **Fix**: Created `redistribute_weights()` function in `topology_wizard.m` that proportionally scales the other two sliders when one changes, maintaining sum = 1.0. Added percentage labels next to each slider (e.g. "33%"). Defaults changed from 0.5 each to 1/3 each.

#### 7d) All recommendations were toroids
- Using `"available cores"` mode which only searches commercially stocked cores — database overwhelmingly contains toroids.
- **Fix**: Changed `core_mode` to `"standard cores"` in `generate_om_recommendations.py`, which searches all standard shape families (E, ETD, PQ, RM, EQ, EL, etc.).

**Verified results**: After fixes, recommendations now return E 20/9/6, EL 20/5.8 cores with proper per-filter scoring. Changing specs produces different recommendations. Changing weight distribution re-ranks results correctly.

Primary files modified:
- `PEEC_Script/generate_om_recommendations.py` — `apply_user_weights()`, core_mode fix, weight key mapping, debug logging
- `PEEC_Script/topology_wizard.m` — `redistribute_weights()`, linked sliders, percentage labels, default weights

---

## Current Behavior (Important for next agent)

### A) Excitation controls are no longer user-editable in GUI
- The run path still uses `data.excitation` internally.
- Defaults currently remain converter-driven (`source='converter'`, sweep `grid`, mode `ccm+dcm`, etc.).
- If behavior changes are needed, they must be edited in code/default struct, not GUI widgets.

### B) OM window-area metric semantics
- For non-windowed OM metadata (e.g., toroidal/no bobbin window), results intentionally show `OM: n/a (no bobbin window)`.

### C) OM vs CWF geometry display can still differ
- CWF is local deterministic layout logic.
- OM view is from OpenMagnetics winding engine output.
- Some packing/interleaving edge cases (especially orthocyclic) may not visually match CWF.

### D) Weight scoring is client-side
- PyOpenMagnetics advisor internally uses equal weights. User weights are applied as a post-processing re-score step using `scoring_per_filter` from each result. This means the candidate pool from the API has default ranking; only the final ordering reflects user weights.

---

## Project File Map

### Core PEEC Solver
| File | Purpose |
|------|---------|
| `peec_solve_frequency.m` | PEEC frequency-domain proximity loss solver |
| `peec_build_geometry.m` | Builds PEEC geometry structure from conductor specs |
| `plot_current_density.m` | Filament-level current density visualization |
| `plot_loss_density.m` | Filament-level loss density visualization |

### OpenMagnetics Integration
| File | Purpose |
|------|---------|
| `openmagnetics_api_interface.m` | Offline database class (wires, cores, materials, suppliers) |
| `openmagnetics_winding_layout.m` | Advanced winding layout calculator (round, litz, foil, rectangular) |
| `parse_om_svg.m` | SVG cross-section renderer (polygons/circles → MATLAB patches) |
| `om_client.m` | HTTP client wrapper for PyOpenMagnetics server (fallback path) |

### Python Bridges
| File | Purpose |
|------|---------|
| `generate_om_recommendations.py` | Design advisor via PyOpenMagnetics (core/winding recommendations) |
| `generate_om_visualization.py` | 2D cross-section SVG generation via `plot_magnetic()` |
| `generate_om_excitation.py` | Converter-driven excitation profiles for PEEC analysis |
| `generate_om_prescreen_losses.py` | Fast winding-loss pre-screen to rank operating points |
| `export_openmagnetics_database.py` | Exports wires/cores/materials/suppliers to JSON |

### User Interfaces
| File | Purpose |
|------|---------|
| `topology_wizard.m` | Entry-point GUI: Topology Wizard, MAS import, or jump to design |
| `interactive_winding_designer.m` | Main GUI: winding design, visualization, analysis, MAS export |

### Reference Documentation
| File | Purpose |
|------|---------|
| `quickref.md` | MAS format quick reference (shapes, materials, wires, topologies) |
| `inputs.md` | Full MAS inputs specification (DesignRequirements, OperatingPoints) |
| `magnetic.md` | MAS magnetic structure (core, coil) |
| `schema.md` | OpenMagnetics data schema |
| `PROJECT_SUMMARY.md` | Overall project overview |
| `CHANGES_SUMMARY.md` | Summary of recent changes |

---

## Known Issues / Open Items

### 1) OM orthocyclic expectation mismatch (still open)
- OM orthocyclic doesn't always visually match CWF orthocyclic due to differing layout engines.

### 2) Full interactive validation still needed
- End-to-end manual GUI validation required for: resize behavior, wizard handoff with multiple recommendations, OM/CWF view toggling, repeated runs with Worst/Best case switching.

### 3) Design Advisor modal flow not implemented
- Requested workflow (Run Analysis triggers advisor candidate selection modal before PEEC run) is still conceptual only.

### 4) Loss values in recommendations are zero
- `core_losses_w` and `winding_losses_w` in recommendation results are 0.0. The advisor may not compute full losses, or the output path may not be extracting them correctly.

### 5) Wire names from advisor are raw internal references
- Wire names like `"Litz DXXL20/34TXX-2(MWXX)"` or `"Round 25.0 - Single Build"` from the advisor may not match the wire database names expected by the designer GUI handoff.

---

## High-Value Next Features

### F1 — Live Inductance & Flux Density Feedback
Display calculated inductance (from turns, core, gap) and peak flux density (B_pk) in real-time as the user adjusts turns, gap, and frequency. Show a green/yellow/red indicator for saturation margin. This closes the loop between design inputs and magnetic performance without running a full PEEC analysis.

### F2 — Core Loss Estimation with Steinmetz / iGSE
Add real-time core loss estimation using the improved Generalized Steinmetz Equation (iGSE) or Steinmetz parameters from the material database. Display core loss alongside winding loss in the results panel. PyOpenMagnetics already has `calculate_core_losses()` — wire this into the analysis pipeline.

### F3 — Thermal Estimation Model
Add a simple thermal resistance network (Rth_core-to-ambient, Rth_winding-to-core) to estimate temperature rise from total losses. Show estimated hot-spot temperature in the results panel. Even a first-order estimate (natural convection, simple geometry) would catch designs that are thermally infeasible before prototyping.

### F4 — Multi-Operating-Point Sweep Visualization
The MAS format supports multiple operating points, and the excitation engine generates a grid. Add a summary heatmap or table showing losses across the full operating envelope (line voltage vs load current), highlighting worst-case corners. This replaces the current single worst/best toggle with a complete picture.

### F5 — Pareto Front Explorer (Cost vs Losses vs Size)
After running the advisor with a large pool, plot the candidates on a 2D Pareto front (e.g. total losses vs volume, or losses vs cost). Let the user click a point to see its details and load it into the designer. This gives engineers the tradeoff visibility they need rather than a ranked list.

### F6 — Winding Build & Insulation Calculator
Given the insulation requirements (creepage, clearance, dielectric withstand from the MAS `InsulationRequirements`), automatically calculate required tape layers, margin tape width, and winding build height. Flag designs where the winding build exceeds the available window height. Critical for safety-certified designs.

### F7 — Leakage Inductance Estimation
Estimate leakage inductance from the winding geometry (layer arrangement, inter-winding spacing) using classical Dowell or Ferreira models. Compare against the `leakage_inductance` design requirement if specified. Important for forward/flyback converters where leakage causes voltage spikes.

### F8 — Export to SPICE / PLECS Model
Generate a transformer equivalent circuit model (magnetizing inductance, leakage inductance, winding resistance with frequency-dependent AC factor from PEEC results) exportable as a SPICE netlist or PLECS component. This bridges the gap between magnetics design and circuit simulation.

### F9 — Automated Wire Gauge Optimization
Given the core/turns/frequency, sweep wire gauges (or litz strand counts) to find the wire that minimizes total winding loss or meets a target temperature rise. Display results as a wire-loss curve showing the optimum. Currently wire selection is manual trial-and-error.

### F10 — Side-by-Side Design Comparison
Allow saving 2-3 design snapshots and displaying them side-by-side with a comparison table (core size, turns, wire, total losses, temperature rise, cost, weight). Engineers always compare candidates — this eliminates manual note-taking.

---

## Handoff Notes for Next Agent
- Start by reading this file plus:
  - `PEEC_Script/PROJECT_SUMMARY.md`
  - `PEEC_Script/CHANGES_SUMMARY.md`
  - `PEEC_Script/quickref.md` (MAS format reference)
- Then validate with this manual flow:
  1. Run `topology_wizard` in Octave
  2. Enter converter specs, adjust weight sliders (should link to 100%)
  3. Click "Get Recommendations" — should return E/ETD/PQ cores (not only toroids)
  4. Pick a recommendation, launch designer
  5. Switch CWF/OM view and layered/orthocyclic
  6. Run analysis and switch Plot Case between Worst/Best
  7. Confirm operating-point details in `Core & Configuration` panel match selected case
- Key Python dependency: `PyOpenMagnetics` (PyMKF) — installed locally, no HTTP server needed
- Octave path caveat: MSYS shell mangles Windows paths — use `strrep(path, '\', '/')` and `pwd()`
